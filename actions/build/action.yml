name: Build
inputs:
  prefix: 
    default: ""
  env-type:
    required: true
    default: None

#   hw-type:
    # required: true
    # default: None

outputs:
  random-number:
    value: 13
runs:
  using: "composite"
  steps:
    # if ${{ inputs.env-type  == 'docker'}}; then
    #   source /usr/share/miniconda/etc/profile.d/conda.sh
    #   conda activate omnisci-dev
    # fi;

    - name: Build
      env:
        CPU_COUNT: 2
      run: |
        echo ${PWD}
        ls -la 
        echo "prefix: " ${{ inputs.prefix }}
        if ${{ inputs.env-type  == 'conda'}}; then
          source /usr/share/miniconda/etc/profile.d/conda.sh
          conda activate omnisci-dev
        fi;
        if ${{ inputs.env-type  == 'docker'}}; then
          echo "=========================container ls========================="
          docker container ls -a
          echo "=========================prefix pwd env========================="
          ${{ inputs.prefix }} pwd && env
          docker start verify
          docker exec verify env && pwd
          echo "=========================container wrong?========================="
          docker run -i --name verify_cpu_dmitriim --network host -u root -v ${PWD}:/home/hdk    devjiu/cpu-hdk:latest /usr/bin/bash -c "groupadd -g `id -g` ghrunner; useradd -m -u `id -u` -g `id -g` -G sudo ghrunner; echo 'ghrunner ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers; chown ghrunner:ghrunner /home/; echo \"ghrunner soft nofile \`ulimit -n\`\" >> /etc/security/limits.conf; echo \"SHELL=/usr/bin/bash\" > /etc/environment ; su ghrunner -s /usr/bin/bash
          docker start verify_cpu_dmitriim
          docker exec verify_cpu_dmitriim env && pwd
          docker exec verify_cpu_dmitriim mkdir build && cd build
          docker exec verify_cpu_dmitriim pwd && cmake ..
        fi;
        ${{ inputs.prefix }} ls -la && mkdir build && cd build
        ${{ inputs.prefix }} ls -la && cmake ..
        ${{ inputs.prefix }} make -j ${{ env.CPU_COUNT }}
        ${{ inputs.prefix }} make install
        ${{ inputs.prefix }} cd ..
        ${{ inputs.prefix }} tar -zcf /tmp/build.tgz .
      shell: bash
